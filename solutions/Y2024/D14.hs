module Y2024.D14 (main) where

import Solution
import AoC.Parsec
import AoC.Coord
import Data.List (group, sort)
import qualified Data.Set as S

isExample :: Bool
isExample = False

width,height :: Int
width  = if isExample then 11 else 101
height = if isExample then 7 else 103

type Robot = (Coord,Coord)

inputP :: Parser Robot
inputP =   (,) <$ string "p="
       <*> pt <* string " v="
       <*> pt
 where
  pt = flip C <$> int <* char ',' <*> int

main :: Solution m => m ()
main = do
  robots <- parse' (sepEndBy1 inputP newline) =<< getInput
  let part1 = map (wait 100) robots
      steps = iterate (map (wait 1)) robots
      (part2, tree) = head [ (i,map fst x)
                           | (i,x) <- zip [0..] steps
                           , isTree (map fst x) ]
  answer $ safetyFactor part1
  answer (part2 :: Int)
  answerStr $ drawCoords tree
{- ^
······································█·····························································
···················█················································································
·············█·······································█··············································
······························█·····································································
···············································································█····················
·······█···········································█································█···············
························█·····································█································█····
··········································································█·························
····································································································
··█····················█·······································█······························█···█·
···············································································█····················
··█·················█··█············································································
········█······█··························█·············································█···········
····································································································
···················█················································································
··············█························█·····················································█······
···········█···················█····························································█·······
············█····················█··································································
···································································································█
································███████████████████████████████·····································
·············█··················█·····························█·····································
································█·····························█·····································
·························█······█·····························█·····································
·····················█·····█····█·····························█································█····
··················█·············█··············█··············█·····································
··············█······█··········█·············███·············█·····································
··········█·····················█············█████············█·····█·······························
································█···········███████···········█·························█······█····
································█··········█████████··········█····················█················
································█············█████············█························█············
·························█······█···········███████···········█······█······················█·······
································█··········█████████··········█·····································
································█·········███████████·········█····························█········
···········█····················█········█████████████········█·····································
·········█······················█··········█████████··········█····█································
································█·········███████████·········█·····································
································█········█████████████········█·····································
································█·······███████████████·······█·····································
································█······█████████████████······█··························█··········
·█················█·············█········█████████████········█·································█···
··························█·····█·······███████████████·······█·····································
····█···························█······█████████████████······█·····································
································█·····███████████████████·····█·····································
······█·············█···········█····█████████████████████····█··················█··················
································█·············███·············█·····································
······························█·█·············███·············█·····································
····························█···█·············███·············█·····································
································█·····························█···························█·········
································█·····························█·····································
································█·····························█·················█···················
································█·····························█········█··························█·
································███████████████████████████████·····································
·············································································█······················
···················█················································································
····█······························································································█
·························█····█··········█··············█······█········█······················█····
····································································································
··············································█·····················█·······························
····································································································
····································································································
······█·····························································································
····································································································
··············█·············································································█·······
····································································································
··································█·································································
·······················································································█············
···················································█················································
···························██·······································································
························█···········································································
····································································································
····················█·····················································█······················█··
············█········································█··············································
······█·····························································································
·································································································█··
····································································································
········█·······················································█·························█·········
····································································································
··············································································█·····················
····································································································
····································································································
····································································································
········█···························································································
···························█············█···········█························█······················
······█··················█·····█·························█·······················█··················
·························································································█·····█····
····························█··············································█························
····································································································
·····█···············█·················································█····························
····································································································
················█··········██·······································································
····································································································
················································█···················································
·························································································█········█·
············································································█·······················
·····························································█······································
······················█·······················█·····················································
············█···············································█·······································
█·····························█·····································································
············█·············█·········█·······························································
··························█·····█··············█·······························█····················
··············█·····················································································
······························█·····································································
···························█············································█···························
-}

-- | This was just a lucky guess. I'm guessing the inputs were designed this way
isTree :: [Coord] -> Bool
isTree pts = length pts == S.size (S.fromList pts)

wait :: Int -> Robot -> Robot
wait secs (C y x,vel@(C vy vx)) = (C y' x', vel)
 where
  y' = (y + secs * vy) `mod` height
  x' = (x + secs * vx) `mod` width

safetyFactor :: [Robot] -> Int
safetyFactor = product
             . map length
             . group . sort
             . map quadrant
             . filter onQuad
             . map fst
 where
  quadrant (C y x) = (2*y<height, 2*x<width)
  onQuad (C y x) = 2*y + 1 /= height && 2*x+1 /= width
